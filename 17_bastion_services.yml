- name: Bastion services configuration
  hosts: bastion
  gather_facts: no
  become: true
  vars_files:
    - vars/infra_vars.yml
    - vars/cluster_vars.yml
  tasks:
    - name: Ensuring tftp boot directory exists
      ansible.builtin.file:
        state: directory
        path: "{{ tftp_boot_root }}/pxelinux.cfg"

    - name: Copy pxelinux.0 file
      ansible.builtin.copy:
        src: /usr/share/syslinux/{{ item }}
        dest: "{{ tftp_boot_root }}/"
        remote_src: yes
      loop: "{{ pxe_files }}"

    - name: Creating seelinux rules for dnsmasq service
      ansible.builtin.copy:
        src: files/my-dnsmasq.pp
        dest: /tmp

    - name: Apply seelinux rules for dnsmasq service
      ansible.builtin.shell: semodule -X 300 -i /tmp/my-dnsmasq.pp 

    - name: Delete selinux temp file
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - /tmp/my-dnsmasq.pp
        - /tmp/my-dnsmasq.te 

    - name: Firing dnsmasq template
      ansible.builtin.template:
        src: templates/dnsmasq.j2
        dest: /etc/dnsmasq.conf

    - block:
      - name: Firing pxe boot template
        ansible.builtin.template:
          src: templates/pxeboot_mac.j2
          dest: "{{ tftp_boot_root }}/pxelinux.cfg/01-{{ hostvars[item].node_mac | replace(':','-') }}"
        loop: "{{ groups['masters'] }}"

      - name: Firing pxe boot template
        ansible.builtin.template:
          src: templates/pxeboot_mac.j2
          dest: "{{ tftp_boot_root }}/pxelinux.cfg/01-{{ hostvars[item].node_mac | replace(':','-') }}"
        loop: "{{ groups['bootstrap'] }}"

      - name: Firing pxe boot template
        ansible.builtin.template:
          src: templates/pxeboot_mac.j2
          dest: "{{ tftp_boot_root }}/pxelinux.cfg/01-{{ hostvars[item].node_mac | replace(':','-') }}"
        loop: "{{ groups['workers'] }}"
      when: hostvars['bastion'].version.1 | int >= 6

    - block:
      - name: Firing pxe boot template
        ansible.builtin.template:
          src: templates/pxeboot_mac_pre-4.6.j2
          dest: "{{ tftp_boot_root }}/pxelinux.cfg/01-{{ hostvars[item].node_mac | replace(':','-') }}"
        loop: "{{ groups['masters'] }}"

      - name: Firing pxe boot template
        ansible.builtin.template:
          src: templates/pxeboot_mac_pre-4.6.j2
          dest: "{{ tftp_boot_root }}/pxelinux.cfg/01-{{ hostvars[item].node_mac | replace(':','-') }}"
        loop: "{{ groups['bootstrap'] }}"

      - name: Firing pxe boot template
        ansible.builtin.template:
          src: templates/pxeboot_mac_pre-4.6.j2
          dest: "{{ tftp_boot_root }}/pxelinux.cfg/01-{{ hostvars[item].node_mac | replace(':','-') }}"
        loop: "{{ groups['workers'] }}"
      when: hostvars['bastion'].version.1 | int <= 5

    - name: Configure {{ host_interface }} to use {{ host_ip }} as DNS server
      ansible.builtin.shell: nmcli con mod {{ host_interface }} ipv4.dns "{{ host_ip }}" 

    - name: Refreshing {{ host_interface }}
      ansible.builtin.shell: nmcli con down "{{ host_interface }}"; nmcli con up "{{ host_interface }}"
                
    - name: Enable services
      ansible.builtin.service:
        name: "{{ item }}"
        enabled: true
        state: started
      loop:
        - dnsmasq
        - nginx

    - name: Enable nfs if needed
      ansible.builtin.service:
        name: nfs-server
        state: started
        enabled: true
      when: nfs_registry_enabled

    - name: Rebooting bastion
      ansible.builtin.reboot:
